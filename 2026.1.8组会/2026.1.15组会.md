# 融合微调 V-JEPA2 与多智能体协作的实时视频异常检测方案

## 1. 背景与目标

**目标**：在监控场景中实现实时异常检测，能区分“无异常 / 异常类型”，并在告警后快速回滚定位异常发生的时间段。

**核心难点**：

- 仅靠无监督方法通常只能“报异常”，难以解释“异常类型”。
- 纯监督分类依赖大量标注，且对时序起止不敏感。
- 实时性要求高，需要在准确率、延迟、成本之间折中。

**总体思路**：以 V-JEPA2 作为视频表征主干，在本域数据上轻量微调，并通过多智能体协作实现“快速筛查 + 复核解释 + 决策执行”。

---

## 2. 数据与标注

**数据形式**：

- 视频片段按固定窗口抽帧（如 16 帧、4–8 fps）。
- 标注包含异常类别与时间边界。

**标注建议**：

- 异常类别：Fighting / Falling / Intrusion / Loitering 等。
- 时间边界：起止帧或起止时间（便于回滚）。

**正常样本策略**：

- 多场景、多时间段、多摄像头，避免“正常分布过窄”。
- 建议混合多个监控数据集的正常部分（如 UCSD / Avenue / ShanghaiTech 正常片段）。

---

## 3. 模型与微调策略

### 3.1 模型角色

- **V-JEPA2 Encoder**：特征提取器，输出时序表征。
- **轻量分类头**：异常类型识别（有标注时）。
- **异常评分器**：异常分数估计（无标注或弱标注时）。
- **条件记忆模块（参考 Engram 思想）**：对常见模式做 O(1) 近似检索，降低计算成本。

### 3.2 微调策略（两阶段）

1) **自监督继续预训练（可选但推荐）**

   - 目的：让表征更贴合监控域分布。
   - 方法：保持 masked latent prediction。
2) **下游微调（必做）**

   - 有异常标签：冻结主干，训练轻量分类头。
   - 无异常标签：用正常数据拟合“正常分布”，构建异常分数。

### 3.3 条件记忆模块（借鉴 Engram）

**动机**：把稳定、重复的局部模式从主干计算中剥离，使用检索替代推理以提升实时性。**实现方式**：

- 将滑窗特征离散化为短序列 token（向量量化或聚类 ID）。
- 为 n-gram 建立哈希索引，实现 O(1) 记忆检索。
- 用 gating 融合：检索结果与上下文一致时增强，否则抑制。

### 3.4 计算-记忆分配原则

- 计算（V-JEPA2）用于复杂场景与长时序理解。
- 记忆（检索）用于局部、可重复模式。
- 部署时通过阈值与比例动态分配，平衡速度与准确率。

### 3.5 实时性参数建议

- 模型：优先 `vitl`（更快更省显存）。
- 输入：224/256 分辨率，16 帧窗口，4–8 fps。
- 推理：FP16/BF16，必要时只跑 backbone。

---

## 4. 多智能体协作框架

### 4.1 角色划分

- **Observer（感知代理）**：抽帧、窗口化、特征提取、初步异常评分。
- **Analyst（分析代理）**：回滚验证、时间一致性检查、相似检索（含条件记忆）。
- **Decider（决策代理）**：根据规则与置信度输出告警并触发动作。

### 4.2 处理流程

1) 实时视频流进入 Observer
2) V-JEPA2 输出特征与异常分数
3) 异常候选触发 Analyst 复核
4) Decider 结合阈值与规则做最终告警

---

## 5. 异常判定逻辑

### 5.1 无异常（正常判定）

- 异常分数低于阈值，且与正常分布/正常模板相似度高 → 正常。
- 记忆检索命中“正常模板” → 抑制异常分数，提高正常置信度。
- 连续多个窗口低异常分数 → 视为稳定正常段。

### 5.2 已知异常（分类路径）

- 分类头置信度 > 阈值（如 0.8） → 直接触发异常类型。

### 5.3 未知异常（评分路径）

- 分类置信度低，但异常分数显著升高 → 标记为“未知异常”。

### 5.4 时间一致性检查（回滚验证）

- 回溯最近 N 秒滑窗，检查异常是否连续出现。
- 过滤单帧噪声或误触发。

### 5.5 记忆一致性校验（参考 Engram）

- 命中“正常模板” → 降低异常分数。
- 命中“异常模板” → 提升异常置信度。

---

## 6. 回滚与数据库设计（轻量实现）

**目标**：异常触发后快速定位时间段并支持回放。

**最小数据结构**：

- `windows`：camera_id, ts_start, ts_end, anomaly_score, is_anomaly, model_version
- `events`：event_id, camera_id, event_start, event_end, peak_score, event_type, confidence
- `clips`：event_id, clip_start, clip_end, storage_uri

**建议实现**：SQLite + 文件系统即可满足验证需求。

---

## 7. 实验与评估

**指标**：

**对比基线**：

---

## 8. 实时性优化要点

- 降采样输入（帧率/分辨率）。
- 主通路只用 backbone，重模型低频触发。
- 异步流水线与特征缓存。
